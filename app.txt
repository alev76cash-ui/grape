"""
üçá –í–ò–ù–û–ì–†–ê–î–ù–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–•
Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∏–∑–∞—Ü–∏–∏ —Å–æ—Ä—Ç–æ–≤ –≤–∏–Ω–æ–≥—Ä–∞–¥–∞
–ê–≤—Ç–æ—Ä: –°–∏—Å—Ç–µ–º–∞
–í–µ—Ä—Å–∏—è: 2.0
"""

from flask import Flask, render_template, request, redirect, url_for, flash, jsonify, Response, session, send_from_directory
import sqlite3
import os
import csv
import json
from io import StringIO, TextIOWrapper, BytesIO
from datetime import datetime
from functools import wraps
import pandas as pd
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
from reportlab.lib import colors
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer
from reportlab.lib.styles import getSampleStyleSheet
from reportlab.lib.units import inch
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from email import encoders
import threading
from werkzeug.utils import secure_filename
import zipfile
import re

# ============ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ============

app = Flask(__name__)
app.secret_key = 'grape-database-secret-key-2024-change-in-production'
DATABASE = 'grape_database.db'

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
app.config['UPLOAD_FOLDER'] = 'static/uploads'
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB
app.config['ALLOWED_EXTENSIONS'] = {'png', 'jpg', 'jpeg', 'gif', 'webp'}

# Email –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–¥–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
app.config['MAIL_SERVER'] = 'smtp.gmail.com'
app.config['MAIL_PORT'] = 587
app.config['MAIL_USE_TLS'] = True
app.config['MAIL_USE_SSL'] = False
app.config['MAIL_USERNAME'] = 'your-email@gmail.com'
app.config['MAIL_PASSWORD'] = 'your-app-password'
app.config['MAIL_DEFAULT_SENDER'] = 'grape-database@example.com'

# –î–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
ADMIN_USERNAME = 'admin'
ADMIN_PASSWORD = 'admin123'

# ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============

def create_structure():
    """–°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"""
    folders = [
        'static/css',
        'static/js',
        'static/images',
        'static/uploads',
        'temp_exports',
        'templates'
    ]

    for folder in folders:
        os.makedirs(folder, exist_ok=True)
        # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª .gitkeep –¥–ª—è –ø—É—Å—Ç—ã—Ö –ø–∞–ø–æ–∫
        keep_file = os.path.join(folder, '.gitkeep')
        if not os.path.exists(keep_file):
            try:
                open(keep_file, 'w').close()
            except:
                pass

    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    default_image = 'static/images/default-grape.jpg'
    if not os.path.exists(default_image):
        try:
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –∑–∞–≥–ª—É—à–∫—É
            from PIL import Image, ImageDraw, ImageFont
            img = Image.new('RGB', (300, 200), color=(106, 13, 173))
            d = ImageDraw.Draw(img)
            d.text((100, 80), "üçá", fill=(255, 255, 255))
            img.save(default_image)
            print(f"‚úÖ –°–æ–∑–¥–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {default_image}")
        except:
            # –ï—Å–ª–∏ PIL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª
            with open(default_image, 'wb') as f:
                f.write(b'')

def get_db_connection():
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect(DATABASE)
    conn.row_factory = sqlite3.Row
    return conn

def allowed_file(filename):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤"""
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in app.config['ALLOWED_EXTENSIONS']

def init_database():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"""
    if not os.path.exists(DATABASE):
        print(f"üì¶ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: {DATABASE}")

        conn = sqlite3.connect(DATABASE)
        cursor = conn.cursor()

        # –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Ä—Ç–æ–≤ –≤–∏–Ω–æ–≥—Ä–∞–¥–∞
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS grape_varieties (
                id INTEGER PRIMARY KEY,
                name TEXT NOT NULL UNIQUE,
                purpose TEXT,
                ripening_period TEXT,
                frost_resistance TEXT,
                berry_color TEXT,
                taste TEXT,
                sugar_content TEXT,
                acidity TEXT,
                image_url TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ email
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS email_subscribers (
                id INTEGER PRIMARY KEY,
                email TEXT NOT NULL UNIQUE,
                name TEXT,
                subscribed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                active BOOLEAN DEFAULT 1
            )
        ''')

        # –¢–∞–±–ª–∏—Ü–∞ –ª–æ–≥–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS activity_logs (
                id INTEGER PRIMARY KEY,
                user TEXT,
                action TEXT,
                details TEXT,
                ip_address TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ä—Ç–æ–≤
        test_varieties = [
            (1, '–õ–æ—Ä–∞', '–°—Ç–æ–ª–æ–≤—ã–π', '–û—á–µ–Ω—å —Ä–∞–Ω–Ω–∏–π (95-105 –¥–Ω–µ–π)', '-22¬∞C', '–ë–µ–ª—ã–π',
             '–°–ª–∞–¥–∫–∏–π, –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π, —Å –º—É—Å–∫–∞—Ç–Ω—ã–º –æ—Ç—Ç–µ–Ω–∫–æ–º', '18-22%', '6-7 –≥/–ª', '/static/images/default-grape.jpg'),
            (2, '–ê—Ä–∫–∞–¥–∏—è', '–°—Ç–æ–ª–æ–≤—ã–π', '–†–∞–Ω–Ω–∏–π (115-125 –¥–Ω–µ–π)', '-21¬∞C', '–ë–µ–ª—ã–π',
             '–ú—É—Å–∫–∞—Ç–Ω—ã–π, —Å–ª–∞–¥–∫–∏–π, —Å –ø—Ä–∏—è—Ç–Ω–æ–π –∫–∏—Å–ª–∏–Ω–∫–æ–π', '16-20%', '6-8 –≥/–ª', '/static/images/default-grape.jpg'),
            (3, '–ö–∏—à–º–∏—à –õ—É—á–∏—Å—Ç—ã–π', '–°—Ç–æ–ª–æ–≤—ã–π', '–†–∞–Ω–Ω–∏–π (125-130 –¥–Ω–µ–π)', '-19¬∞C', '–†–æ–∑–æ–≤—ã–π',
             '–°–ª–∞–¥–∫–∏–π, –Ω–µ–∂–Ω—ã–π, –±–µ–∑ –∫–æ—Å—Ç–æ—á–µ–∫', '18-21%', '5-7 –≥/–ª', '/static/images/default-grape.jpg'),
            (4, '–í–∏–∫—Ç–æ—Ä–∏—è', '–°—Ç–æ–ª–æ–≤—ã–π', '–†–∞–Ω–Ω–∏–π (115-120 –¥–Ω–µ–π)', '-27¬∞C', '–†–æ–∑–æ–≤—ã–π',
             '–°–ª–∞–¥–∫–∏–π, —Å –ª–µ–≥–∫–∏–º –º—É—Å–∫–∞—Ç–æ–º, —Å–æ—á–Ω—ã–π', '16-18%', '6-7 –≥/–ª', '/static/images/default-grape.jpg'),
            (5, '–¢–∞–ª–∏—Å–º–∞–Ω', '–°—Ç–æ–ª–æ–≤—ã–π', '–†–∞–Ω–Ω–∏–π (120-125 –¥–Ω–µ–π)', '-24¬∞C', '–ë–µ–ª—ã–π',
             '–ú—É—Å–∫–∞—Ç–Ω—ã–π, –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π, —Å —Ü–≤–µ—Ç–æ—á–Ω—ã–º–∏ –Ω–æ—Ç–∞–º–∏', '17-22%', '6-8 –≥/–ª', '/static/images/default-grape.jpg'),
            (6, '–ú–æ–ª–¥–æ–≤–∞', '–°—Ç–æ–ª–æ–≤—ã–π', '–ü–æ–∑–¥–Ω–∏–π (155-165 –¥–Ω–µ–π)', '-23¬∞C', '–¢—ë–º–Ω–æ-—Å–∏–Ω–∏–π',
             '–°–ª–∞–¥–∫–∏–π, —Å –ª–µ–≥–∫–æ–π –∫–∏—Å–ª–∏–Ω–∫–æ–π, —Ç–µ—Ä–ø–∫–∏–π', '16-18%', '8-9 –≥/–ª', '/static/images/default-grape.jpg'),
            (7, '–†–∫–∞—Ü–∏—Ç–µ–ª–∏', '–í–∏–Ω–Ω—ã–π', '–°—Ä–µ–¥–Ω–∏–π (140-150 –¥–Ω–µ–π)', '-20¬∞C', '–ë–µ–ª—ã–π',
             '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —Å —Ñ—Ä—É–∫—Ç–æ–≤—ã–º–∏ –Ω–æ—Ç–∞–º–∏', '18-22%', '7-9 –≥/–ª', '/static/images/default-grape.jpg'),
            (8, '–ö–∞–±–µ—Ä–Ω–µ –°–æ–≤–∏–Ω—å–æ–Ω', '–í–∏–Ω–Ω—ã–π', '–ü–æ–∑–¥–Ω–∏–π (165-175 –¥–Ω–µ–π)', '-19¬∞C', '–¢—ë–º–Ω–æ-—Å–∏–Ω–∏–π',
             '–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–π, —Å —Ç–æ–Ω–∞–º–∏ —á–µ—Ä–Ω–æ–π —Å–º–æ—Ä–æ–¥–∏–Ω—ã –∏ —Å–ø–µ—Ü–∏–π', '20-24%', '8-10 –≥/–ª', '/static/images/default-grape.jpg'),
            (9, '–ú–µ—Ä–ª–æ', '–í–∏–Ω–Ω—ã–π', '–°—Ä–µ–¥–Ω–∏–π (145-155 –¥–Ω–µ–π)', '-18¬∞C', '–¢—ë–º–Ω–æ-—Å–∏–Ω–∏–π',
             '–ú—è–≥–∫–∏–π, –æ–∫—Ä—É–≥–ª—ã–π, —Å —Ç–æ–Ω–∞–º–∏ –≤–∏—à–Ω–∏ –∏ —à–æ–∫–æ–ª–∞–¥–∞', '19-23%', '7-9 –≥/–ª', '/static/images/default-grape.jpg'),
            (10, '–®–∞—Ä–¥–æ–Ω–µ', '–í–∏–Ω–Ω—ã–π', '–°—Ä–µ–¥–Ω–∏–π (140-150 –¥–Ω–µ–π)', '-17¬∞C', '–ë–µ–ª—ã–π',
             '–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π, —Å –Ω–æ—Ç–∞–º–∏ —Ü–∏—Ç—Ä—É—Å–æ–≤—ã—Ö –∏ —è–±–ª–æ–∫–∞', '18-22%', '6-8 –≥/–ª', '/static/images/default-grape.jpg'),
            (11, '–ò–∑–∞–±–µ–ª–ª–∞', '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π', '–ü–æ–∑–¥–Ω–∏–π (150-160 –¥–Ω–µ–π)', '-28¬∞C', '–¢—ë–º–Ω–æ-—Å–∏–Ω–∏–π',
             '–°–ª–∞–¥–∫–∏–π, —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–º –∑–µ–º–ª—è–Ω–∏—á–Ω—ã–º –∞—Ä–æ–º–∞—Ç–æ–º', '16-18%', '8-10 –≥/–ª', '/static/images/default-grape.jpg'),
            (12, '–õ–∏–¥–∏—è', '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π', '–ü–æ–∑–¥–Ω–∏–π (155-165 –¥–Ω–µ–π)', '-26¬∞C', '–†–æ–∑–æ–≤—ã–π',
             '–°–ª–∞–¥–∫–∏–π, —Å –∑–µ–º–ª—è–Ω–∏—á–Ω—ã–º –∞—Ä–æ–º–∞—Ç–æ–º', '17-19%', '7-9 –≥/–ª', '/static/images/default-grape.jpg')
        ]

        cursor.executemany('''
            INSERT OR IGNORE INTO grape_varieties
            (id, name, purpose, ripening_period, frost_resistance, berry_color, taste, sugar_content, acidity, image_url)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', test_varieties)

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
        test_subscribers = [
            ('admin@example.com', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'),
            ('user@example.com', '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'),
            ('vineyard@example.com', '–í–∏–Ω–æ–≥—Ä–∞–¥–∞—Ä—å')
        ]

        for email, name in test_subscribers:
            cursor.execute('''
                INSERT OR IGNORE INTO email_subscribers (email, name)
                VALUES (?, ?)
            ''', (email, name))

        conn.commit()
        conn.close()

        print(f"‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ —Å {len(test_varieties)} —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Å–æ—Ä—Ç–∞–º–∏")
    else:
        print(f"‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: {DATABASE}")

# ============ –î–ï–ö–û–†–ê–¢–û–†–´ ============

def admin_required(f):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not session.get('is_admin'):
            flash('üîí –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'error')
            return redirect(url_for('admin_login'))
        return f(*args, **kwargs)
    return decorated_function

def log_activity(action, details=""):
    """–õ–æ–≥–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    try:
        conn = get_db_connection()
        user = 'admin' if session.get('is_admin') else 'guest'
        ip = request.remote_addr

        conn.execute('''
            INSERT INTO activity_logs (user, action, details, ip_address)
            VALUES (?, ?, ?, ?)
        ''', (user, action, details, ip))

        conn.commit()
        conn.close()
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")

# ============ EMAIL –§–£–ù–ö–¶–ò–ò ============

def send_email_async(subject, body, recipients, attachment=None):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ email (–∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –¥–µ–º–æ)"""
    def send():
        try:
            # –í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
            print(f"üìß –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email:")
            print(f"   –¢–µ–º–∞: {subject}")
            print(f"   –ü–æ–ª—É—á–∞—Ç–µ–ª–∏: {recipients}")
            print(f"   –¢–µ–ª–æ: {body[:100]}...")

            # –†–µ–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SMTP
            # msg = MIMEMultipart()
            # msg['Subject'] = subject
            # msg['From'] = app.config['MAIL_DEFAULT_SENDER']
            # msg['To'] = ', '.join(recipients)
            # msg.attach(MIMEText(body, 'html' if '<html>' in body else 'plain'))
            # ... –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ SMTP ...

        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email: {e}")

    thread = threading.Thread(target=send)
    thread.start()
    return thread

# ============ PDF –ò EXCEL –§–£–ù–ö–¶–ò–ò ============

def generate_pdf_report(varieties):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PDF –æ—Ç—á–µ—Ç"""
    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=letter)

    styles = getSampleStyleSheet()
    story = []

    # –ó–∞–≥–æ–ª–æ–≤–æ–∫
    title = Paragraph("–ö–∞—Ç–∞–ª–æ–≥ —Å–æ—Ä—Ç–æ–≤ –≤–∏–Ω–æ–≥—Ä–∞–¥–∞", styles['Title'])
    story.append(title)
    story.append(Spacer(1, 12))

    # –î–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    date_str = Paragraph(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {datetime.now().strftime('%d.%m.%Y %H:%M')}", styles['Normal'])
    story.append(date_str)
    story.append(Spacer(1, 24))

    # –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö
    data = [['ID', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ', '–¶–≤–µ—Ç', '–ú–æ—Ä–æ–∑–æ—Å—Ç–æ–π–∫–æ—Å—Ç—å']]

    for variety in varieties:
        data.append([
            str(variety['id']),
            variety['name'],
            variety['purpose'] or '-',
            variety['berry_color'] or '-',
            variety['frost_resistance'] or '-'
        ])

    table = Table(data, colWidths=[0.5*inch, 2*inch, 1.5*inch, 1*inch, 1.5*inch])
    table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
        ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, 0), 12),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
        ('GRID', (0, 0), (-1, -1), 1, colors.black),
        ('FONTSIZE', (0, 1), (-1, -1), 10),
    ]))

    story.append(table)
    story.append(Spacer(1, 24))

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    stats = Paragraph(f"–í—Å–µ–≥–æ —Å–æ—Ä—Ç–æ–≤: {len(varieties)}", styles['Normal'])
    story.append(stats)

    doc.build(story)
    buffer.seek(0)
    return buffer

def export_to_excel():
    """–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Excel"""
    conn = get_db_connection()

    query = '''
        SELECT id, name, purpose, ripening_period, frost_resistance,
               berry_color, taste, sugar_content, acidity,
               strftime('%Y-%m-%d', created_at) as created_at
        FROM grape_varieties
        ORDER BY name
    '''

    df = pd.read_sql_query(query, conn)
    conn.close()

    # –°–æ–∑–¥–∞–µ–º Excel writer
    output = BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        # –û—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç
        df.to_excel(writer, sheet_name='–°–æ—Ä—Ç–∞ –≤–∏–Ω–æ–≥—Ä–∞–¥–∞', index=False)

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        stats_data = {
            '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞': [
                f'–í—Å–µ–≥–æ —Å–æ—Ä—Ç–æ–≤: {len(df)}',
                f'–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π: {df["purpose"].nunique()}',
                f'–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤: {df["berry_color"].nunique()}',
                f'–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞: {datetime.now().strftime("%d.%m.%Y %H:%M")}'
            ]
        }
        stats_df = pd.DataFrame(stats_data)
        stats_df.to_excel(writer, sheet_name='–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', index=False)

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫
        worksheet = writer.sheets['–°–æ—Ä—Ç–∞ –≤–∏–Ω–æ–≥—Ä–∞–¥–∞']
        for i, col in enumerate(df.columns):
            column_width = max(df[col].astype(str).map(len).max(), len(col)) + 2
            worksheet.set_column(i, i, column_width)

    output.seek(0)
    return output

# ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –®–ê–ë–õ–û–ù–û–í ============

def normalize_for_search(text):
    """–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞: –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä, —ë‚Üí–µ, –π‚Üí–∏"""
    if not text:
        return ""

    text = str(text).lower()
    text = text.replace('—ë', '–µ').replace('–π', '–∏')
    text = text.replace('–Å', '–µ').replace('–ô', '–∏')
    return text

def parse_frost_resistance(frost_str):
    """–ü–∞—Ä—Å–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –º–æ—Ä–æ–∑–æ—Å—Ç–æ–π–∫–æ—Å—Ç–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏"""
    try:
        if not frost_str:
            return 0

        # –ò—â–µ–º —á–∏—Å–ª–∞ –≤ —Å—Ç—Ä–æ–∫–µ
        import re
        numbers = re.findall(r'-?\d+', frost_str)
        if numbers:
            return abs(int(numbers[0]))  # –ë–µ—Ä–µ–º –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        return 0
    except:
        return 0

def get_color_code(color_name):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç HEX –∫–æ–¥ —Ü–≤–µ—Ç–∞ –¥–ª—è CSS"""
    color_map = {
        '–ë–µ–ª—ã–π': '#FFFFFF',
        '–ó–µ–ª–µ–Ω—ã–π': '#4CAF50',
        '–†–æ–∑–æ–≤—ã–π': '#E91E63',
        '–ö—Ä–∞—Å–Ω—ã–π': '#F44336',
        '–°–∏–Ω–∏–π': '#2196F3',
        '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π': '#9C27B0',
        '–¢—ë–º–Ω–æ-—Å–∏–Ω–∏–π': '#303F9F',
        '–ß—ë—Ä–Ω—ã–π': '#212121',
        '–ñ–µ–ª—Ç—ã–π': '#FFEB3B',
        '–û—Ä–∞–Ω–∂–µ–≤—ã–π': '#FF9800'
    }
    return color_map.get(color_name, '#CCCCCC')

def get_ripening_category(period):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–æ–∑—Ä–µ–≤–∞–Ω–∏—è"""
    if not period:
        return '–ù–µ —É–∫–∞–∑–∞–Ω'

    period_lower = str(period).lower()

    if '–æ—á–µ–Ω—å —Ä–∞–Ω–Ω–∏–π' in period_lower or '—Å–≤–µ—Ä—Ö—Ä–∞–Ω–Ω–∏–π' in period_lower:
        return '–û—á–µ–Ω—å —Ä–∞–Ω–Ω–∏–π'
    elif '—Ä–∞–Ω–Ω–∏–π' in period_lower:
        return '–†–∞–Ω–Ω–∏–π'
    elif '—Å—Ä–µ–¥–Ω–∏–π' in period_lower:
        return '–°—Ä–µ–¥–Ω–∏–π'
    elif '–ø–æ–∑–¥–Ω–∏–π' in period_lower or '—Å—Ä–µ–¥–Ω–µ–ø–æ–∑–¥–Ω–∏–π' in period_lower:
        return '–ü–æ–∑–¥–Ω–∏–π'
    else:
        return '–ù–µ —É–∫–∞–∑–∞–Ω'

# ============ –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–¶–ï–°–°–û–† ============

@app.context_processor
def inject_template_vars():
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –≤–æ –≤—Å–µ —à–∞–±–ª–æ–Ω—ã"""

    def is_admin():
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
        return session.get('is_admin', False)

    def total_count():
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ä—Ç–æ–≤"""
        try:
            conn = get_db_connection()
            count = conn.execute('SELECT COUNT(*) FROM grape_varieties').fetchone()[0]
            conn.close()
            return count
        except:
            return 0

    def now():
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è"""
        return datetime.now()

    def get_default_image_url():
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        return '/static/images/default-grape.jpg'

    return dict(
        is_admin=is_admin,
        total_count=total_count,
        now=now,
        get_default_image_url=get_default_image_url,
        get_color_code=get_color_code,
        get_ripening_category=get_ripening_category,
        parse_frost_resistance=parse_frost_resistance
    )

# ============ –ú–ê–†–®–†–£–¢–´ ============

@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    return render_template('index.html')

@app.route('/user')
def user_home():
    """–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–∞—Ç–∞–ª–æ–≥ —Å–æ—Ä—Ç–æ–≤"""
    search = request.args.get('search', '').strip()
    page = request.args.get('page', 1, type=int)
    per_page = 12

    conn = get_db_connection()

    if search:
        # –†–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –ø–æ–∏—Å–∫ —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
        search_normalized = normalize_for_search(search)
        all_varieties = conn.execute('SELECT * FROM grape_varieties').fetchall()

        filtered_varieties = []
        for variety in all_varieties:
            variety_name_normalized = normalize_for_search(variety['name'])
            if search_normalized in variety_name_normalized:
                filtered_varieties.append(variety)

        total = len(filtered_varieties)
        total_pages = (total + per_page - 1) // per_page
        offset = (page - 1) * per_page
        varieties = filtered_varieties[offset:offset + per_page]
    else:
        total = conn.execute('SELECT COUNT(*) FROM grape_varieties').fetchone()[0]
        total_pages = (total + per_page - 1) // per_page
        offset = (page - 1) * per_page

        varieties = conn.execute('''
            SELECT * FROM grape_varieties
            ORDER BY name
            LIMIT ? OFFSET ?
        ''', (per_page, offset)).fetchall()

    # –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    purposes = conn.execute('''
        SELECT DISTINCT purpose
        FROM grape_varieties
        WHERE purpose IS NOT NULL AND purpose != ''
        ORDER BY purpose
    ''').fetchall()

    colors = conn.execute('''
        SELECT DISTINCT berry_color
        FROM grape_varieties
        WHERE berry_color IS NOT NULL AND berry_color != ''
        ORDER BY berry_color
    ''').fetchall()

    conn.close()

    log_activity('user_home', f'search={search}, page={page}')

    return render_template('user_home.html',
                         varieties=varieties,
                         search=search,
                         page=page,
                         total_pages=total_pages,
                         total=total,
                         purposes=purposes,
                         colors=colors)

@app.route('/admin')
@admin_required
def admin_home():
    """–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å"""
    search = request.args.get('search', '').strip()
    sort = request.args.get('sort', 'name')
    order = request.args.get('order', 'asc')
    page = request.args.get('page', 1, type=int)
    per_page = 50

    conn = get_db_connection()

    query = 'SELECT * FROM grape_varieties WHERE 1=1'
    params = []

    if search:
        search_normalized = normalize_for_search(search)
        all_varieties = conn.execute('SELECT * FROM grape_varieties').fetchall()

        filtered_varieties = []
        for variety in all_varieties:
            variety_name_normalized = normalize_for_search(variety['name'])
            if search_normalized in variety_name_normalized:
                filtered_varieties.append(variety)

        # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        reverse = (order.lower() == 'desc')

        if sort == 'name':
            filtered_varieties.sort(key=lambda x: normalize_for_search(x['name']), reverse=reverse)
        elif sort == 'purpose':
            filtered_varieties.sort(key=lambda x: normalize_for_search(x['purpose'] or ''), reverse=reverse)
        elif sort == 'ripening_period':
            filtered_varieties.sort(key=lambda x: normalize_for_search(x['ripening_period'] or ''), reverse=reverse)
        elif sort == 'frost_resistance':
            filtered_varieties.sort(key=lambda x: parse_frost_resistance(x['frost_resistance']), reverse=reverse)
        elif sort == 'berry_color':
            filtered_varieties.sort(key=lambda x: normalize_for_search(x['berry_color'] or ''), reverse=reverse)
        elif sort == 'id':
            filtered_varieties.sort(key=lambda x: x['id'], reverse=reverse)
        else:
            filtered_varieties.sort(key=lambda x: x['id'], reverse=reverse)

        total = len(filtered_varieties)
        total_pages = (total + per_page - 1) // per_page
        offset = (page - 1) * per_page
        varieties = filtered_varieties[offset:offset + per_page]
    else:
        # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        allowed_sorts = ['id', 'name', 'purpose', 'ripening_period', 'frost_resistance', 'berry_color']
        if sort not in allowed_sorts:
            sort = 'name'

        query += f' ORDER BY {sort} {order.upper()}'

        # –ü–æ–¥—Å—á–µ—Ç
        count_query = query.replace('SELECT *', 'SELECT COUNT(*)')
        if 'ORDER BY' in count_query:
            count_query = count_query.split('ORDER BY')[0]

        total = conn.execute(count_query, params).fetchone()[0]
        total_pages = (total + per_page - 1) // per_page
        offset = (page - 1) * per_page

        varieties = conn.execute(query + ' LIMIT ? OFFSET ?', params + [per_page, offset]).fetchall()

    conn.close()

    visible_columns = session.get('visible_columns', ['id', 'name', 'purpose', 'ripening_period', 'frost_resistance'])

    log_activity('admin_home', f'search={search}, sort={sort}')

    return render_template('admin_home.html',
                         varieties=varieties,
                         search=search,
                         sort=sort,
                         order=order,
                         page=page,
                         total_pages=total_pages,
                         total=total,
                         visible_columns=visible_columns)

@app.route('/admin/login', methods=['GET', 'POST'])
def admin_login():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')

        # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —Ç–æ–ª—å–∫–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if username == ADMIN_USERNAME:
            session['is_admin'] = True
            flash('‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', 'success')
            log_activity('admin_login', 'success')
            return redirect(url_for('admin_home'))
        else:
            flash('‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error')
            log_activity('admin_login', 'failed')

    return render_template('admin_login.html')

@app.route('/admin/logout')
def admin_logout():
    """–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"""
    session.pop('is_admin', None)
    flash('üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info')
    log_activity('admin_logout')
    return redirect(url_for('user_home'))

@app.route('/view/<int:id>')
def view_variety(id):
    """–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ä—Ç–µ"""
    conn = get_db_connection()
    variety = conn.execute('SELECT * FROM grape_varieties WHERE id = ?', (id,)).fetchone()
    conn.close()

    if variety is None:
        flash('‚ùå –°–æ—Ä—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error')
        return redirect(url_for('user_home'))

    log_activity('view_variety', f'id={id}')

    return render_template('view.html', variety=variety)

@app.route('/add', methods=['GET', 'POST'])
@admin_required
def add_variety():
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ—Ä—Ç–∞"""
    if request.method == 'POST':
        name = request.form.get('name', '').strip()
        purpose = request.form.get('purpose', '')
        ripening_period = request.form.get('ripening_period', '')
        frost_resistance = request.form.get('frost_resistance', '')
        berry_color = request.form.get('berry_color', '')
        taste = request.form.get('taste', '')
        sugar_content = request.form.get('sugar_content', '')
        acidity = request.form.get('acidity', '')
        image_file = request.files.get('image')

        if not name:
            flash('‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Ä—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ', 'error')
            return render_template('add.html', form_data=request.form)

        conn = get_db_connection()

        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
            existing = conn.execute(
                'SELECT id FROM grape_varieties WHERE LOWER(name) = LOWER(?)',
                (name,)
            ).fetchone()

            if existing:
                flash(f'‚ùå –°–æ—Ä—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "{name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (ID: {existing["id"]})', 'error')
                return render_template('add.html', form_data=request.form)

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            image_url = get_default_image_url()
            if image_file and allowed_file(image_file.filename):
                filename = secure_filename(image_file.filename)
                timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
                filename = f"{timestamp}_{filename}"

                os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
                filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
                image_file.save(filepath)
                image_url = f"/static/uploads/{filename}"

            # –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π ID
            max_id_result = conn.execute('SELECT MAX(id) FROM grape_varieties').fetchone()
            max_id = max_id_result[0] if max_id_result[0] is not None else 0
            new_id = max_id + 1

            # –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å–æ—Ä—Ç
            conn.execute('''
                INSERT INTO grape_varieties
                (id, name, purpose, ripening_period, frost_resistance,
                 berry_color, taste, sugar_content, acidity, image_url)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (new_id, name, purpose, ripening_period, frost_resistance,
                  berry_color, taste, sugar_content, acidity, image_url))

            conn.commit()

            flash(f'‚úÖ –°–æ—Ä—Ç "{name}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω (ID: {new_id})', 'success')
            log_activity('add_variety', f'name={name}, id={new_id}')

            return redirect(url_for('admin_home'))

        except Exception as e:
            flash(f'‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: {str(e)}', 'error')
            return render_template('add.html', form_data=request.form)
        finally:
            conn.close()

    return render_template('add.html')

@app.route('/edit/<int:id>', methods=['GET', 'POST'])
@admin_required
def edit_variety(id):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ä—Ç–∞"""
    conn = get_db_connection()

    if request.method == 'GET':
        variety = conn.execute('SELECT * FROM grape_varieties WHERE id = ?', (id,)).fetchone()
        conn.close()

        if not variety:
            flash('‚ùå –°–æ—Ä—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error')
            return redirect(url_for('admin_home'))

        return render_template('edit.html', variety=variety)

    elif request.method == 'POST':
        try:
            name = request.form.get('name', '').strip()
            purpose = request.form.get('purpose', '')
            ripening_period = request.form.get('ripening_period', '')
            frost_resistance = request.form.get('frost_resistance', '')
            berry_color = request.form.get('berry_color', '')
            taste = request.form.get('taste', '')
            sugar_content = request.form.get('sugar_content', '')
            acidity = request.form.get('acidity', '')
            image_file = request.files.get('image')

            if not name:
                flash('‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Ä—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ', 'error')
                return redirect(url_for('edit_variety', id=id))

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç (–∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π —Å–æ—Ä—Ç)
            existing = conn.execute('''
                SELECT id FROM grape_varieties
                WHERE LOWER(name) = LOWER(?) AND id != ?
            ''', (name, id)).fetchone()

            if existing:
                flash(f'‚ùå –°–æ—Ä—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "{name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (ID: {existing["id"]})', 'error')
                return redirect(url_for('edit_variety', id=id))

            # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            update_query = '''
                UPDATE grape_varieties
                SET name = ?, purpose = ?, ripening_period = ?,
                    frost_resistance = ?, berry_color = ?, taste = ?,
                    sugar_content = ?, acidity = ?, updated_at = CURRENT_TIMESTAMP
            '''
            params = [name, purpose, ripening_period, frost_resistance,
                     berry_color, taste, sugar_content, acidity]

            # –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if image_file and allowed_file(image_file.filename):
                filename = secure_filename(image_file.filename)
                timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
                filename = f"{timestamp}_{filename}"
                filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
                image_file.save(filepath)
                update_query += ', image_url = ?'
                params.append(f"/static/uploads/{filename}")

            update_query += ' WHERE id = ?'
            params.append(id)

            conn.execute(update_query, params)
            conn.commit()

            flash(f'‚úÖ –°–æ—Ä—Ç "{name}" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success')
            log_activity('edit_variety', f'id={id}, name={name}')

        except Exception as e:
            flash(f'‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: {str(e)}', 'error')
        finally:
            conn.close()

        return redirect(url_for('view_variety', id=id))

@app.route('/delete/<int:id>', methods=['POST'])
@admin_required
def delete_variety(id):
    """–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∞"""
    conn = get_db_connection()

    try:
        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
        variety = conn.execute('SELECT name FROM grape_varieties WHERE id = ?', (id,)).fetchone()

        if variety:
            conn.execute('DELETE FROM grape_varieties WHERE id = ?', (id,))
            conn.commit()
            flash(f'‚úÖ –°–æ—Ä—Ç "{variety["name"]}" —É–¥–∞–ª–µ–Ω', 'success')
            log_activity('delete_variety', f'id={id}, name={variety["name"]}')
        else:
            flash('‚ùå –°–æ—Ä—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error')

    except Exception as e:
        flash(f'‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: {str(e)}', 'error')
    finally:
        conn.close()

    return redirect(url_for('admin_home'))

# ============ EMAIL –£–ü–†–ê–í–õ–ï–ù–ò–ï ============

@app.route('/admin/email/subscribers')
@admin_required
def email_subscribers():
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    conn = get_db_connection()
    subscribers = conn.execute('SELECT * FROM email_subscribers ORDER BY subscribed_at DESC').fetchall()
    conn.close()

    return render_template('email_subscribers.html', subscribers=subscribers)

@app.route('/admin/email/add', methods=['POST'])
@admin_required
def add_email_subscriber():
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞"""
    email = request.form.get('email')
    name = request.form.get('name')

    if not email:
        flash('Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω', 'error')
        return redirect(url_for('email_subscribers'))

    conn = get_db_connection()
    try:
        conn.execute('''
            INSERT OR REPLACE INTO email_subscribers (email, name)
            VALUES (?, ?)
        ''', (email, name))
        conn.commit()
        flash('‚úÖ –ü–æ–¥–ø–∏—Å—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω', 'success')
        log_activity('add_subscriber', f'email={email}')
    except Exception as e:
        flash(f'‚ùå –û—à–∏–±–∫–∞: {str(e)}', 'error')
    finally:
        conn.close()

    return redirect(url_for('email_subscribers'))

@app.route('/admin/email/delete/<int:id>', methods=['POST'])
@admin_required
def delete_email_subscriber(id):
    """–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞"""
    conn = get_db_connection()
    try:
        conn.execute('DELETE FROM email_subscribers WHERE id = ?', (id,))
        conn.commit()
        flash('‚úÖ –ü–æ–¥–ø–∏—Å—á–∏–∫ —É–¥–∞–ª–µ–Ω', 'success')
        log_activity('delete_subscriber', f'id={id}')
    except Exception as e:
        flash(f'‚ùå –û—à–∏–±–∫–∞: {str(e)}', 'error')
    finally:
        conn.close()

    return redirect(url_for('email_subscribers'))

@app.route('/admin/email/send-test')
@admin_required
def send_test_email():
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ email"""
    try:
        subject = "–¢–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤–∏–Ω–æ–≥—Ä–∞–¥–∞"
        body = f"""
        <html>
        <body>
            <h2>–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ</h2>
            <p>–ï—Å–ª–∏ –≤—ã –ø–æ–ª—É—á–∏–ª–∏ —ç—Ç–æ –ø–∏—Å—å–º–æ, –∑–Ω–∞—á–∏—Ç —Å–∏—Å—Ç–µ–º–∞ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.</p>
            <p>–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {datetime.now().strftime('%d.%m.%Y %H:%M')}</p>
        </body>
        </html>
        """

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
        conn = get_db_connection()
        subscribers = conn.execute('SELECT email FROM email_subscribers WHERE active = 1').fetchall()
        conn.close()

        recipients = [sub['email'] for sub in subscribers] if subscribers else [app.config['MAIL_DEFAULT_SENDER']]

        send_email_async(subject, body, recipients)
        flash('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success')
        log_activity('send_test_email')
    except Exception as e:
        flash(f'‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {str(e)}', 'error')

    return redirect(url_for('email_subscribers'))

@app.route('/admin/email/send-monthly')
@admin_required
def send_monthly_email():
    """–†—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        conn = get_db_connection()
        total = conn.execute('SELECT COUNT(*) FROM grape_varieties').fetchone()[0]
        subscribers = conn.execute('SELECT email FROM email_subscribers WHERE active = 1').fetchall()
        conn.close()

        month = datetime.now().strftime('%B %Y')
        subject = f"üìä –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –±–∞–∑–µ –≤–∏–Ω–æ–≥—Ä–∞–¥–∞ - {month}"

        body = f"""
        <html>
        <body>
            <h2>üìä –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤–∏–Ω–æ–≥—Ä–∞–¥–∞</h2>
            <p><strong>–ü–µ—Ä–∏–æ–¥:</strong> {month}</p>
            <p><strong>–í—Å–µ–≥–æ —Å–æ—Ä—Ç–æ–≤ –≤ –±–∞–∑–µ:</strong> {total}</p>
            <p>–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.</p>
        </body>
        </html>
        """

        recipients = [sub['email'] for sub in subscribers] if subscribers else []
        if recipients:
            send_email_async(subject, body, recipients)
            flash(f'‚úÖ –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω {len(recipients)} –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º', 'success')
        else:
            flash('‚ÑπÔ∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞', 'info')

        log_activity('send_monthly_report')
    except Exception as e:
        flash(f'‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {str(e)}', 'error')

    return redirect(url_for('email_subscribers'))

# ============ –ò–ú–ü–û–†–¢ CSV ============

@app.route('/import/csv', methods=['GET', 'POST'])
@admin_required
def import_csv():
    """–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)"""
    if request.method == 'GET':
        return render_template('import.html')

    elif request.method == 'POST':
        if 'csv_file' not in request.files:
            flash('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω', 'error')
            return redirect(request.url)

        file = request.files['csv_file']
        if file.filename == '':
            flash('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω', 'error')
            return redirect(request.url)

        if file and file.filename.endswith('.csv'):
            try:
                csv_file = TextIOWrapper(file.stream, encoding='utf-8')
                reader = csv.DictReader(csv_file)

                conn = get_db_connection()
                imported = 0
                skipped = 0

                for row in reader:
                    name = row.get('–ù–∞–∑–≤–∞–Ω–∏–µ') or row.get('name') or row.get('Name')
                    if not name:
                        continue

                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
                    existing = conn.execute(
                        'SELECT id FROM grape_varieties WHERE LOWER(name) = LOWER(?)',
                        (name.strip(),)
                    ).fetchone()

                    if existing:
                        skipped += 1
                        continue

                    # –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π ID
                    max_id_result = conn.execute('SELECT MAX(id) FROM grape_varieties').fetchone()
                    max_id = max_id_result[0] if max_id_result[0] is not None else 0
                    new_id = max_id + 1

                    purpose = row.get('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ') or row.get('purpose') or ''
                    ripening = row.get('–°—Ä–æ–∫ —Å–æ–∑—Ä–µ–≤–∞–Ω–∏—è') or row.get('ripening_period') or ''
                    frost = row.get('–ú–æ—Ä–æ–∑–æ—Å—Ç–æ–π–∫–æ—Å—Ç—å') or row.get('frost_resistance') or ''
                    color = row.get('–¶–≤–µ—Ç —è–≥–æ–¥') or row.get('berry_color') or ''
                    taste = row.get('–í–∫—É—Å') or row.get('taste') or ''
                    sugar = row.get('–°–∞—Ö–∞—Ä') or row.get('sugar_content') or ''
                    acidity = row.get('–ö–∏—Å–ª–æ—Ç–Ω–æ—Å—Ç—å') or row.get('acidity') or ''

                    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    image_url = get_default_image_url()

                    conn.execute('''
                        INSERT INTO grape_varieties
                        (id, name, purpose, ripening_period, frost_resistance,
                         berry_color, taste, sugar_content, acidity, image_url)
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    ''', (
                        new_id,
                        name.strip(),
                        purpose.strip(),
                        ripening.strip(),
                        frost.strip(),
                        color.strip(),
                        taste.strip(),
                        sugar.strip(),
                        acidity.strip(),
                        image_url
                    ))

                    imported += 1

                conn.commit()
                conn.close()

                flash(f'‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ {imported} —Å–æ—Ä—Ç–æ–≤, –ø—Ä–æ–ø—É—â–µ–Ω–æ {skipped} —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö', 'success')
                log_activity('import_csv', f'imported={imported}, skipped={skipped}')

            except Exception as e:
                flash(f'‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: {str(e)}', 'error')
                return redirect(request.url)

    return render_template('import.html')

# ============ –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–• ============

@app.route('/export/csv')
@admin_required
def export_csv():
    """–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV"""
    conn = get_db_connection()
    varieties = conn.execute('SELECT * FROM grape_varieties ORDER BY name').fetchall()
    conn.close()

    output = StringIO()
    writer = csv.writer(output, delimiter=',', quotechar='"', quoting=csv.QUOTE_MINIMAL)

    # –ó–∞–≥–æ–ª–æ–≤–∫–∏
    writer.writerow(['ID', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ', '–°—Ä–æ–∫ —Å–æ–∑—Ä–µ–≤–∞–Ω–∏—è',
                    '–ú–æ—Ä–æ–∑–æ—Å—Ç–æ–π–∫–æ—Å—Ç—å', '–¶–≤–µ—Ç —è–≥–æ–¥', '–í–∫—É—Å',
                    '–°–∞—Ö–∞—Ä', '–ö–∏—Å–ª–æ—Ç–Ω–æ—Å—Ç—å', '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'])

    # –î–∞–Ω–Ω—ã–µ
    for variety in varieties:
        writer.writerow([
            variety['id'],
            variety['name'],
            variety['purpose'] or '',
            variety['ripening_period'] or '',
            variety['frost_resistance'] or '',
            variety['berry_color'] or '',
            variety['taste'] or '',
            variety['sugar_content'] or '',
            variety['acidity'] or '',
            variety['image_url'] or ''
        ])

    response = Response(
        output.getvalue(),
        mimetype='text/csv',
        headers={'Content-Disposition': 'attachment; filename=grape_varieties.csv'}
    )

    log_activity('export_csv')
    return response

@app.route('/export/excel')
@admin_required
def export_excel():
    """–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel"""
    excel_data = export_to_excel()

    response = Response(
        excel_data.getvalue(),
        mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        headers={'Content-Disposition': 'attachment; filename=grape_varieties.xlsx'}
    )

    log_activity('export_excel')
    return response

@app.route('/export/pdf')
@admin_required
def export_pdf():
    """–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF"""
    conn = get_db_connection()
    varieties = conn.execute('SELECT * FROM grape_varieties ORDER BY name LIMIT 50').fetchall()
    conn.close()

    pdf_buffer = generate_pdf_report(varieties)

    response = Response(
        pdf_buffer.getvalue(),
        mimetype='application/pdf',
        headers={'Content-Disposition': 'attachment; filename=grape_varieties.pdf'}
    )

    log_activity('export_pdf')
    return response

@app.route('/export/all')
@admin_required
def export_all():
    """–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –≤ ZIP"""
    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    temp_dir = 'temp_exports'
    os.makedirs(temp_dir, exist_ok=True)

    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º CSV
    csv_response = export_csv()
    csv_path = os.path.join(temp_dir, f'grape_varieties_{timestamp}.csv')
    with open(csv_path, 'w', encoding='utf-8') as f:
        f.write(csv_response.get_data(as_text=True))

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Excel
    excel_data = export_to_excel()
    excel_path = os.path.join(temp_dir, f'grape_varieties_{timestamp}.xlsx')
    with open(excel_path, 'wb') as f:
        f.write(excel_data.getvalue())

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
    pdf_response = export_pdf()
    pdf_path = os.path.join(temp_dir, f'grape_varieties_{timestamp}.pdf')
    with open(pdf_path, 'wb') as f:
        f.write(pdf_response.get_data())

    # –°–æ–∑–¥–∞–µ–º ZIP
    zip_buffer = BytesIO()
    with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
        for file_path in [csv_path, excel_path, pdf_path]:
            if os.path.exists(file_path):
                zip_file.write(file_path, os.path.basename(file_path))

    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    for file_path in [csv_path, excel_path, pdf_path]:
        try:
            os.remove(file_path)
        except:
            pass

    try:
        os.rmdir(temp_dir)
    except:
        pass

    zip_buffer.seek(0)

    log_activity('export_all')

    return Response(
        zip_buffer.getvalue(),
        mimetype='application/zip',
        headers={'Content-Disposition': f'attachment; filename=grape_varieties_{timestamp}.zip'}
    )

# ============ –ù–ê–°–¢–†–û–ô–ö–ê –°–¢–û–õ–ë–¶–û–í ============

@app.route('/admin/columns', methods=['GET', 'POST'])
@admin_required
def admin_columns():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"""
    default_columns = ['id', 'name', 'purpose', 'ripening_period', 'frost_resistance']

    if request.method == 'POST':
        selected_columns = request.form.getlist('columns')

        # ID –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å
        if 'id' not in selected_columns:
            selected_columns.insert(0, 'id')
        if 'name' not in selected_columns:
            selected_columns.insert(1, 'name')

        session['visible_columns'] = selected_columns
        flash('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success')
        log_activity('update_columns', f'columns={selected_columns}')
        return redirect(url_for('admin_home'))

    current_columns = session.get('visible_columns', default_columns)

    all_columns = [
        {'id': 'id', 'name': 'ID', 'required': True, 'description': '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä'},
        {'id': 'name', 'name': '–ù–∞–∑–≤–∞–Ω–∏–µ', 'required': True, 'description': '–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Ä—Ç–∞'},
        {'id': 'purpose', 'name': '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ', 'required': False, 'description': '–°—Ç–æ–ª–æ–≤—ã–π/–í–∏–Ω–Ω—ã–π/–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π'},
        {'id': 'ripening_period', 'name': '–°—Ä–æ–∫ —Å–æ–∑—Ä–µ–≤–∞–Ω–∏—è', 'required': False, 'description': '–†–∞–Ω–Ω–∏–π/–°—Ä–µ–¥–Ω–∏–π/–ü–æ–∑–¥–Ω–∏–π'},
        {'id': 'frost_resistance', 'name': '–ú–æ—Ä–æ–∑–æ—Å—Ç–æ–π–∫–æ—Å—Ç—å', 'required': False, 'description': '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—ã–∂–∏–≤–∞–Ω–∏—è'},
        {'id': 'berry_color', 'name': '–¶–≤–µ—Ç —è–≥–æ–¥', 'required': False, 'description': '–¶–≤–µ—Ç —è–≥–æ–¥'},
        {'id': 'taste', 'name': '–í–∫—É—Å', 'required': False, 'description': '–û–ø–∏—Å–∞–Ω–∏–µ –≤–∫—É—Å–∞'},
        {'id': 'sugar_content', 'name': '–°–∞—Ö–∞—Ä', 'required': False, 'description': '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–∞—Ö–∞—Ä–∞'},
        {'id': 'acidity', 'name': '–ö–∏—Å–ª–æ—Ç–Ω–æ—Å—Ç—å', 'required': False, 'description': '–£—Ä–æ–≤–µ–Ω—å –∫–∏—Å–ª–æ—Ç–Ω–æ—Å—Ç–∏'},
        {'id': 'created_at', 'name': '–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è', 'required': False, 'description': '–ö–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω'}
    ]

    # –û—Ç–º–µ—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
    for column in all_columns:
        column['checked'] = column['id'] in current_columns

    return render_template('admin_columns.html', columns=all_columns)

@app.route('/admin/columns/reset', methods=['POST'])
@admin_required
def reset_columns():
    """–°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–æ–ª–±—Ü–æ–≤"""
    session.pop('visible_columns', None)
    flash('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ —Å–±—Ä–æ—à–µ–Ω—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º', 'info')
    log_activity('reset_columns')
    return redirect(url_for('admin_columns'))

# ============ –°–¢–ê–¢–ò–°–¢–ò–ö–ê ============

@app.route('/stats')
@admin_required
def stats():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    conn = get_db_connection()

    total = conn.execute('SELECT COUNT(*) FROM grape_varieties').fetchone()[0]

    purpose_stats = conn.execute('''
        SELECT purpose, COUNT(*) as count
        FROM grape_varieties
        WHERE purpose IS NOT NULL AND purpose != ''
        GROUP BY purpose
        ORDER BY count DESC
    ''').fetchall()

    color_stats = conn.execute('''
        SELECT berry_color, COUNT(*) as count
        FROM grape_varieties
        WHERE berry_color IS NOT NULL AND berry_color != ''
        GROUP BY berry_color
        ORDER BY count DESC
    ''').fetchall()

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–æ—Ä–æ–∑–æ—Å—Ç–æ–π–∫–æ—Å—Ç–∏
    frost_stats = conn.execute('''
        SELECT
            CASE
                WHEN frost_resistance LIKE '-2%' OR frost_resistance LIKE '%-2%' THEN '–£–º–µ—Ä–µ–Ω–Ω–∞—è (-20¬∞C to -29¬∞C)'
                WHEN frost_resistance LIKE '-3%' OR frost_resistance LIKE '%-3%' THEN '–í—ã—Å–æ–∫–∞—è (-30¬∞C to -39¬∞C)'
                WHEN frost_resistance LIKE '-4%' OR frost_resistance LIKE '%-4%' THEN '–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è (-40¬∞C+)'
                ELSE '–ù–µ —É–∫–∞–∑–∞–Ω–∞'
            END as frost_category,
            COUNT(*) as count
        FROM grape_varieties
        GROUP BY frost_category
        ORDER BY count DESC
    ''').fetchall()

    conn.close()

    log_activity('view_stats')

    return render_template('stats.html',
                         total=total,
                         purpose_stats=purpose_stats,
                         color_stats=color_stats,
                         frost_stats=frost_stats)

# ============ API –≠–ù–î–ü–û–ò–ù–¢–´ ============

@app.route('/api/varieties')
def api_varieties():
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ—Ä—Ç–æ–≤ (JSON)"""
    conn = get_db_connection()
    varieties = conn.execute('SELECT * FROM grape_varieties ORDER BY name').fetchall()
    conn.close()

    result = []
    for variety in varieties:
        result.append(dict(variety))

    return jsonify(result)

@app.route('/api/variety/<int:id>')
def api_variety(id):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Å–æ—Ä—Ç–∞"""
    conn = get_db_connection()
    variety = conn.execute('SELECT * FROM grape_varieties WHERE id = ?', (id,)).fetchone()
    conn.close()

    if variety:
        return jsonify(dict(variety))
    else:
        return jsonify({'error': '–°–æ—Ä—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404

@app.route('/api/search')
def api_search():
    """API –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ—Ä—Ç–æ–≤"""
    search = request.args.get('q', '')
    limit = request.args.get('limit', 20, type=int)

    conn = get_db_connection()

    if search:
        search_normalized = normalize_for_search(search)
        all_varieties = conn.execute('''
            SELECT id, name, purpose, berry_color, frost_resistance
            FROM grape_varieties
        ''').fetchall()

        results = []
        for variety in all_varieties:
            variety_name_normalized = normalize_for_search(variety['name'])
            if search_normalized in variety_name_normalized:
                results.append(variety)
                if len(results) >= limit:
                    break
    else:
        results = conn.execute('''
            SELECT id, name, purpose, berry_color, frost_resistance
            FROM grape_varieties
            ORDER BY name
            LIMIT ?
        ''', (limit,)).fetchall()

    conn.close()

    return jsonify([dict(row) for row in results])

# ============ –°–¢–ê–¢–ò–ß–ï–°–ö–ò–ï –§–ê–ô–õ–´ ============

@app.route('/static/<path:filename>')
def serve_static(filename):
    """–û–±—Å–ª—É–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã"""
    return send_from_directory('static', filename)

# ============ –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –û–®–ò–ë–û–ö ============

@app.errorhandler(404)
def page_not_found(e):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏ 404"""
    return render_template('404.html'), 404

@app.errorhandler(500)
def internal_server_error(e):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏ 500"""
    return render_template('500.html'), 500

# ============ –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ============

if __name__ == '__main__':
    # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫
    create_structure()

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    init_database()

    print("=" * 70)
    print("üçá –í–ò–ù–û–ì–†–ê–î–ù–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–•")
    print("=" * 70)
    print("üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞...")
    print("üìÅ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: grape_database.db")
    print("üåê URL: http://localhost:5000")
    print("üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: http://localhost:5000/user")
    print("üëë –ê–¥–º–∏–Ω: http://localhost:5000/admin")
    print("üîê –õ–æ–≥–∏–Ω –∞–¥–º–∏–Ω–∞: admin / admin123")
    print("=" * 70)

    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    app.run(
        debug=True,
        host='0.0.0.0',
        port=5000,
        threaded=True
    )
