{% extends "base.html" %}

{% block title %}üìß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ email —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="display-5 fw-bold text-dark">
            <i class="fas fa-envelope me-2 text-primary"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ email —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏
        </h1>
        <p class="lead text-dark">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="d-flex gap-2 justify-content-end">
            <a href="{{ url_for('admin_home') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>–ù–∞–∑–∞–¥
            </a>
            <a href="{{ url_for('stats') }}" class="btn btn-outline-info">
                <i class="fas fa-chart-bar me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </a>
        </div>
    </div>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ -->
<div class="alert alert-info mb-4">
    <h6 class="alert-heading text-dark">
        <i class="fas fa-info-circle me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ email
    </h6>
    <p class="mb-0 text-dark small">
        –°–∏—Å—Ç–µ–º–∞ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º.
        –í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –ø–∏—Å—å–º–∞ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞.
        –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ SMTP —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–∞–π–ª–µ <code>app.py</code>.
    </p>
</div>

<!-- –¢–µ—Å—Ç–æ–≤—ã–µ –ø–∏—Å—å–º–∞ -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">
            <i class="fas fa-paper-plane me-2"></i>–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–∏—Å–µ–º
        </h5>
    </div>
    <div class="card-body">
        <p class="text-dark mb-3">
            –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ –∏–ª–∏ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º
        </p>
        <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('send_test_email') }}" class="btn btn-outline-info"
               onclick="return confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º?')">
                <i class="fas fa-envelope me-2"></i>–¢–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ
            </a>
            <a href="{{ url_for('send_monthly_email') }}" class="btn btn-outline-warning"
               onclick="return confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º?')">
                <i class="fas fa-chart-bar me-2"></i>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç
            </a>
            <a href="{{ url_for('export_csv') }}" class="btn btn-outline-success">
                <i class="fas fa-download me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç —Å–ø–∏—Å–∫–∞
            </a>
        </div>
    </div>
</div>

<!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">
            <i class="fas fa-user-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞
        </h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('add_email_subscriber') }}" class="row g-3 needs-validation" novalidate>
            <div class="col-md-6">
                <label for="email" class="form-label text-dark">
                    <i class="fas fa-envelope me-1"></i>Email –∞–¥—Ä–µ—Å *
                </label>
                <input type="email"
                       class="form-control"
                       id="email"
                       name="email"
                       required
                       placeholder="example@domain.com">
                <div class="invalid-feedback">
                    –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å.
                </div>
                <div class="form-text">
                    Email –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞.
                </div>
            </div>
            <div class="col-md-4">
                <label for="name" class="form-label text-dark">
                    <i class="fas fa-user me-1"></i>–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                </label>
                <input type="text"
                       class="form-control"
                       id="name"
                       name="name"
                       placeholder="–ò–º—è –ø–æ–¥–ø–∏—Å—á–∏–∫–∞">
                <div class="form-text">
                    –ò–º—è –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–∏—Å—å–º–∞—Ö.
                </div>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">
                    <i class="fas fa-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </form>

        <!-- –ü—Ä–∏–º–µ—Ä—ã email -->
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-lightbulb me-1"></i>
                –ü—Ä–∏–º–µ—Ä—ã: user@example.com, admin@vineyard.com, info@grape-db.com
            </small>
        </div>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ -->
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-users me-2"></i>–°–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
            <span class="badge bg-light text-dark ms-2">{{ subscribers|length }}</span>
        </h5>
    </div>
    <div class="card-body">
        {% if subscribers %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>–ò–º—è</th>
                        <th>–î–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for subscriber in subscribers %}
                    <tr>
                        <td>{{ subscriber.id }}</td>
                        <td>
                            <i class="fas fa-envelope me-2 text-muted"></i>
                            <a href="mailto:{{ subscriber.email }}" class="text-decoration-none">
                                {{ subscriber.email }}
                            </a>
                        </td>
                        <td>
                            {% if subscriber.name %}
                                {{ subscriber.name }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ subscriber.subscribed_at[:10] if subscriber.subscribed_at else '-' }}
                            </small>
                        </td>
                        <td>
                            {% if subscriber.active %}
                            <span class="badge bg-success">
                                <i class="fas fa-check-circle me-1"></i>–ê–∫—Ç–∏–≤–µ–Ω
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-times-circle me-1"></i>–ù–µ–∞–∫—Ç–∏–≤–µ–Ω
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button"
                                        class="btn btn-outline-info"
                                        onclick="copyToClipboard('{{ subscriber.email }}')"
                                        data-bs-toggle="tooltip"
                                        data-bs-title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å email">
                                    <i class="fas fa-copy"></i>
                                </button>

                                <form method="POST"
                                      action="{{ url_for('delete_email_subscriber', id=subscriber.id) }}"
                                      class="d-inline"
                                      onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ {{ subscriber.email }}?');">
                                    <button type="submit"
                                            class="btn btn-outline-danger"
                                            data-bs-toggle="tooltip"
                                            data-bs-title="–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="mt-3 pt-3 border-top">
            <div class="row text-center">
                <div class="col-md-4">
                    <div class="stat-badge">
                        <span class="stat-number">{{ subscribers|length }}</span>
                        <span class="stat-label">–í—Å–µ–≥–æ</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-badge">
                        <span class="stat-number">{{ subscribers|selectattr('active')|list|length }}</span>
                        <span class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-badge">
                        <span class="stat-number">{{ subscribers|rejectattr('active')|list|length }}</span>
                        <span class="stat-label">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</span>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h4 class="text-dark">–ù–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</h4>
            <p class="text-muted mb-4">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ –¥–ª—è email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                –ë–µ–∑ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ —Å–∏—Å—Ç–µ–º–∞ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ —Å–º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–∏—Å—å–º–∞.
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ -->
<div class="card border-0 bg-light mt-4">
    <div class="card-body">
        <h5 class="card-title text-dark">
            <i class="fas fa-cog me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ email
        </h5>
        <p class="card-text text-dark small">
            –î–ª—è —Ä–∞–±–æ—Ç—ã —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ email —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ SMTP —Å–µ—Ä–≤–µ—Ä–∞:
        </p>
        <ol class="text-dark small">
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª <code>app.py</code></li>
            <li>–ù–∞–π–¥–∏—Ç–µ —Å–µ–∫—Ü–∏—é <strong>"Email –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"</strong></li>
            <li>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞—à–µ–≥–æ SMTP —Å–µ—Ä–≤–µ—Ä–∞:
                <ul>
                    <li><code>MAIL_SERVER</code> - –∞–¥—Ä–µ—Å SMTP —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, smtp.gmail.com)</li>
                    <li><code>MAIL_PORT</code> - –ø–æ—Ä—Ç (–æ–±—ã—á–Ω–æ 587 –¥–ª—è TLS)</li>
                    <li><code>MAIL_USERNAME</code> - –≤–∞—à email</li>
                    <li><code>MAIL_PASSWORD</code> - –ø–∞—Ä–æ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</li>
                </ul>
            </li>
            <li>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</li>
        </ol>
        <div class="alert alert-warning mt-2">
            <i class="fas fa-shield-alt me-2"></i>
            <strong>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</strong> –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –≤ –∫–æ–¥–µ.
            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã.
        </div>
    </div>
</div>

<!-- –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–æ–∫ (–∑–∞–≥–ª—É—à–∫–∞) -->
<div class="card border-0 mt-4">
    <div class="card-header bg-secondary text-white">
        <h6 class="mb-0">
            <i class="fas fa-history me-2"></i>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        </h6>
    </div>
    <div class="card-body">
        <div class="text-center py-3">
            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
            <p class="text-muted mb-0">–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞</p>
            <small class="text-muted">–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –≥–¥–µ –∑–∞–ø—É—â–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤</small>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stat-badge {
    background: var(--gradient-primary);
    border-radius: var(--radius-md);
    padding: 1rem;
    color: white;
    text-align: center;
}

.stat-badge .stat-number {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1;
}

.stat-badge .stat-label {
    font-size: 0.8rem;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table th {
    background-color: var(--grape-light);
    border-bottom: 2px solid var(--grape-primary);
}

.btn-group .btn {
    padding: 0.25rem 0.5rem;
}

[data-bs-theme="dark"] .table th {
    background-color: var(--grape-card-dark);
}

[data-bs-theme="dark"] .card-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
(function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            form.classList.add('was-validated')
        }, false)
    })
})()

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ email
    const emailInput = document.getElementById('email')
    if (emailInput) {
        emailInput.focus()
    }
})

// –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const alertDiv = document.createElement('div')
        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed'
        alertDiv.style.top = '20px'
        alertDiv.style.right = '20px'
        alertDiv.style.zIndex = '9999'
        alertDiv.style.minWidth = '300px'
        alertDiv.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            Email —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: <strong>${text}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `
        document.body.appendChild(alertDiv)

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alertDiv)
            bsAlert.close()
        }, 3000)

    }).catch(function(err) {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err)
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å email')
    })
}
</script>
{% endblock %}
